<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Flag Frenzy: Global Agent</title>
    <!-- Google Font: JetBrains Mono (Tech feel) & Inter -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">
    <style>
        /* --- CORE VARIABLES & RESET --- */
        :root {
            --bg-color: #0f172a;
            --panel-bg: rgba(30, 41, 59, 0.7);
            --panel-border: rgba(148, 163, 184, 0.1);
            --accent-primary: #38bdf8; /* Sky Blue */
            --accent-secondary: #818cf8; /* Indigo */
            --accent-success: #34d399; /* Emerald */
            --accent-danger: #f87171; /* Red */
            --accent-warn: #fbbf24; /* Amber */
            --text-main: #f1f5f9;
            --text-muted: #94a3b8;
            --font-ui: 'Inter', sans-serif;
            --font-mono: 'JetBrains Mono', monospace;
            --glass-blur: blur(12px);
            --shadow-lg: 0 10px 30px -5px rgba(0, 0, 0, 0.5);
            --shadow-glow: 0 0 15px rgba(56, 189, 248, 0.15);
        }

        body {
            margin: 0;
            font-family: var(--font-ui);
            background-color: var(--bg-color);
            background-image: 
                radial-gradient(circle at 10% 20%, rgba(56, 189, 248, 0.05) 0%, transparent 20%),
                radial-gradient(circle at 90% 80%, rgba(129, 140, 248, 0.05) 0%, transparent 20%),
                linear-gradient(rgba(15, 23, 42, 0.95) 1px, transparent 1px),
                linear-gradient(90deg, rgba(15, 23, 42, 0.95) 1px, transparent 1px);
            background-size: 100% 100%, 100% 100%, 40px 40px, 40px 40px;
            color: var(--text-main);
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 20px;
            box-sizing: border-box;
        }

        /* --- UTILITIES --- */
        .hidden { display: none !important; }
        .text-mono { font-family: var(--font-mono); }
        .text-accent { color: var(--accent-primary); }
        .text-success { color: var(--accent-success); }
        .text-danger { color: var(--accent-danger); }

        /* --- LAYOUT CONTAINER --- */
        .game-container {
            background: var(--panel-bg);
            backdrop-filter: var(--glass-blur);
            -webkit-backdrop-filter: var(--glass-blur);
            border: 1px solid var(--panel-border);
            border-radius: 1.5rem;
            padding: 2rem;
            width: 100%;
            max-width: 550px;
            box-shadow: var(--shadow-lg), var(--shadow-glow);
            text-align: center;
            position: relative;
            overflow: hidden;
            animation: slideUp 0.6s cubic-bezier(0.16, 1, 0.3, 1);
        }

        /* Decorative top bar */
        .game-container::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 4px;
            background: linear-gradient(90deg, var(--accent-primary), var(--accent-secondary));
        }

        @keyframes slideUp {
            from { opacity: 0; transform: translateY(30px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* --- TYPOGRAPHY --- */
        h1 {
            font-size: 2rem;
            font-weight: 800;
            letter-spacing: -0.05em;
            margin: 0 0 0.5rem 0;
            background: linear-gradient(135deg, #fff 0%, #cbd5e1 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        h2 {
            font-size: 1.5rem;
            color: var(--accent-primary);
            margin-bottom: 1rem;
        }

        p {
            color: var(--text-muted);
            line-height: 1.6;
            margin-bottom: 1.5rem;
        }

        /* --- HUD / STATS --- */
        .hud-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 0.5rem;
            margin-bottom: 1.5rem;
            padding: 0.75rem;
            background: rgba(15, 23, 42, 0.5);
            border-radius: 0.75rem;
            border: 1px solid var(--panel-border);
        }

        .hud-item {
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .hud-label {
            font-size: 0.7rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: var(--text-muted);
            margin-bottom: 0.25rem;
        }

        .hud-value {
            font-family: var(--font-mono);
            font-weight: 700;
            font-size: 1.1rem;
        }

        /* --- TIMER BAR --- */
        .timer-container {
            width: 100%;
            height: 6px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 3px;
            margin-bottom: 1.5rem;
            overflow: hidden;
            position: relative;
        }

        .timer-bar {
            height: 100%;
            background: var(--accent-primary);
            width: 100%;
            transition: width 1s linear, background-color 0.3s ease;
            box-shadow: 0 0 10px var(--accent-primary);
        }

        .timer-bar.critical {
            background: var(--accent-danger);
            box-shadow: 0 0 10px var(--accent-danger);
            animation: pulse 0.5s infinite alternate;
        }

        @keyframes pulse {
            from { opacity: 0.6; }
            to { opacity: 1; }
        }

        /* --- INPUTS --- */
        input[type="text"] {
            width: 100%;
            padding: 1rem;
            background: rgba(15, 23, 42, 0.6);
            border: 2px solid var(--panel-border);
            border-radius: 0.75rem;
            color: var(--text-main);
            font-family: var(--font-mono);
            font-size: 1.1rem;
            text-align: center;
            margin-bottom: 1.5rem;
            transition: all 0.2s ease;
            box-sizing: border-box;
        }

        input[type="text"]:focus {
            outline: none;
            border-color: var(--accent-primary);
            box-shadow: 0 0 0 4px rgba(56, 189, 248, 0.1);
        }

        /* --- BUTTONS --- */
        .btn-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 0.75rem;
        }
        
        @media (min-width: 480px) {
            .btn-grid { grid-template-columns: 1fr 1fr; }
        }

        button {
            background: rgba(56, 189, 248, 0.1);
            border: 1px solid rgba(56, 189, 248, 0.2);
            color: var(--accent-primary);
            padding: 1rem;
            border-radius: 0.75rem;
            font-family: var(--font-ui);
            font-weight: 600;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.2s ease;
            position: relative;
            overflow: hidden;
            width: 100%;
        }

        button:hover:not(:disabled) {
            background: rgba(56, 189, 248, 0.2);
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(56, 189, 248, 0.1);
            border-color: var(--accent-primary);
            color: #fff;
        }

        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            filter: grayscale(1);
        }

        .btn-primary {
            background: var(--accent-primary);
            color: #0f172a;
            border: none;
            font-weight: 800;
        }
        .btn-primary:hover:not(:disabled) {
            background: #0ea5e9;
            color: #fff;
        }

        .btn-mode {
            padding: 1.5rem;
            text-align: left;
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }
        .btn-mode small {
            font-weight: 400;
            opacity: 0.8;
            font-size: 0.85rem;
        }

        .option-btn {
            background: rgba(30, 41, 59, 0.8);
            border: 1px solid var(--panel-border);
            color: var(--text-main);
            min-height: 60px;
        }

        .option-btn.correct {
            background: rgba(52, 211, 153, 0.2);
            border-color: var(--accent-success);
            color: var(--accent-success);
        }

        .option-btn.wrong {
            background: rgba(248, 113, 113, 0.2);
            border-color: var(--accent-danger);
            color: var(--accent-danger);
        }

        /* --- FLAG DISPLAY --- */
        .flag-frame {
            position: relative;
            padding: 0.5rem;
            border: 1px solid var(--panel-border);
            border-radius: 1rem;
            background: rgba(15, 23, 42, 0.5);
            margin-bottom: 1.5rem;
            box-shadow: inset 0 0 20px rgba(0,0,0,0.5);
        }
        
        .flag-frame::after {
            content: "SECURE CONNECTION";
            position: absolute;
            bottom: -10px;
            right: 15px;
            background: var(--bg-color);
            padding: 0 10px;
            font-size: 0.6rem;
            color: var(--accent-success);
            font-family: var(--font-mono);
            border: 1px solid var(--panel-border);
            border-radius: 10px;
        }

        #flag-display {
            width: 100%;
            height: auto;
            border-radius: 0.5rem;
            display: block;
            aspect-ratio: 3/2;
            object-fit: cover;
            background: #1e293b;
        }

        /* --- NARRATIVE BOX --- */
        .narrative-box {
            background: rgba(15, 23, 42, 0.8);
            border-left: 3px solid var(--accent-primary);
            padding: 1rem;
            text-align: left;
            font-size: 0.95rem;
            border-radius: 0 0.5rem 0.5rem 0;
            margin-bottom: 1.5rem;
            font-style: italic;
            color: #cbd5e1;
        }

        /* --- ANIMATIONS --- */
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }
        .anim-shake { animation: shake 0.3s ease-in-out; }
        
        @keyframes pop {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }
        .anim-pop { animation: pop 0.2s ease-out; }

    </style>
</head>
<body>

    <!-- 1. INITIAL CREDIT -->
    <div id="screen-credit" class="game-container">
        <h1>FLAG FRENZY</h1>
        <p class="text-mono text-accent">GLOBAL AGENT PROTOCOL</p>
        <div style="height: 1px; background: var(--panel-border); width: 50%; margin: 2rem auto;"></div>
        <p style="font-size: 0.9rem; opacity: 0.7;">System Design by Kyran Fernandes</p>
        <button id="btn-intro-start" class="btn-primary">INITIALIZE SYSTEM</button>
    </div>

    <!-- 2. AGENT PROFILE & MODE SELECTION -->
    <div id="screen-setup" class="game-container hidden">
        <h2>IDENTIFICATION REQUIRED</h2>
        <p>Enter your codename to access the database.</p>
        
        <input type="text" id="input-agent-name" placeholder="CODENAME" maxlength="15" autocomplete="off">
        
        <div id="mode-selection" class="hidden anim-pop">
            <p style="margin-bottom: 1rem;">SELECT OPERATION MODE</p>
            <div class="btn-grid">
                <button class="btn-mode" onclick="startGame('campaign')">
                    <span class="text-accent">CAMPAIGN</span>
                    <small>Story driven. Regional missions. 3 Lives.</small>
                </button>
                <button class="btn-mode" onclick="startGame('timeAttack')">
                    <span class="text-danger">TIME ATTACK</span>
                    <small>Endless mode. 60s Timer. Bonus time for speed.</small>
                </button>
            </div>
        </div>

        <button id="btn-submit-name" class="btn-primary">VERIFY IDENTITY</button>
    </div>

    <!-- 3. NARRATIVE / BRIEFING -->
    <div id="screen-briefing" class="game-container hidden">
        <h2 id="briefing-title">MISSION BRIEFING</h2>
        <div class="narrative-box" id="briefing-text"></div>
        <div id="briefing-details" class="hud-grid hidden">
            <div class="hud-item">
                <span class="hud-label">REGION</span>
                <span class="hud-value text-accent" id="briefing-region">-</span>
            </div>
            <div class="hud-item">
                <span class="hud-label">TARGETS</span>
                <span class="hud-value" id="briefing-targets">0</span>
            </div>
            <div class="hud-item">
                <span class="hud-label">TIME LIMIT</span>
                <span class="hud-value text-danger" id="briefing-time">∞</span>
            </div>
        </div>
        <button id="btn-start-mission" class="btn-primary">ACCEPT ASSIGNMENT</button>
    </div>

    <!-- 4. MAIN GAMEPLAY -->
    <div id="screen-game" class="game-container hidden">
        <div class="hud-grid">
            <div class="hud-item">
                <span class="hud-label">SCORE</span>
                <span class="hud-value text-accent" id="game-score">0</span>
            </div>
            <div class="hud-item">
                <span class="hud-label">TIMER</span>
                <span class="hud-value text-mono" id="game-timer">00</span>
            </div>
            <div class="hud-item">
                <span class="hud-label">LIVES</span>
                <span class="hud-value text-danger" id="game-lives">3</span>
            </div>
        </div>

        <div class="timer-container">
            <div id="timer-bar" class="timer-bar" style="width: 100%;"></div>
        </div>

        <div class="flag-frame">
            <img id="flag-display" src="" alt="Flag">
        </div>

        <div id="options-container" class="btn-grid">
            <!-- Options injected here -->
        </div>
        
        <p id="feedback-msg" style="height: 1.5rem; margin-top: 1rem; font-weight: 700;"></p>
    </div>

    <!-- 5. MISSION OUTCOME (Campaign Only) -->
    <div id="screen-outcome" class="game-container hidden">
        <h2 id="outcome-title">MISSION COMPLETE</h2>
        <p id="outcome-text"></p>
        <button id="btn-outcome-action" class="btn-primary">PROCEED</button>
    </div>

    <!-- 6. GAME OVER -->
    <div id="screen-gameover" class="game-container hidden">
        <h2 id="gameover-title">OPERATIONAL REPORT</h2>
        <p id="gameover-msg">Assignment Terminated.</p>
        
        <div class="hud-grid" style="margin-top: 2rem;">
            <div class="hud-item">
                <span class="hud-label">FINAL SCORE</span>
                <span class="hud-value text-accent" id="final-score">0</span>
            </div>
            <div class="hud-item">
                <span class="hud-label">ACCURACY</span>
                <span class="hud-value" id="final-accuracy">0%</span>
            </div>
            <div class="hud-item">
                <span class="hud-label">STATUS</span>
                <span class="hud-value" id="final-status">ACTIVE</span>
            </div>
        </div>

        <div class="btn-grid" style="margin-top: 2rem;">
            <button onclick="location.reload()" class="btn-primary">RESTART SYSTEM</button>
            <button onclick="location.reload()">MAIN MENU</button>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const FLAG_CDN = "https://flagcdn.com/w640/";
            
            let gameState = {
                mode: 'campaign',
                agentName: 'Agent',
                score: 0,
                lives: 3,
                level: 0,
                timeLeft: 0,
                timerInterval: null,
                currentFlag: null,
                isPaused: false,
                stats: { correct: 0, total: 0 }
            };

            const flags = [
                { country: "Afghanistan", code: "af", continent: "Asia" },
                { country: "Albania", code: "al", continent: "Europe" },
                { country: "Algeria", code: "dz", continent: "Africa" },
                { country: "Andorra", code: "ad", continent: "Europe" },
                { country: "Angola", code: "ao", continent: "Africa" },
                { country: "Argentina", code: "ar", continent: "South America" },
                { country: "Australia", code: "au", continent: "Oceania" },
                { country: "Austria", code: "at", continent: "Europe" },
                { country: "Bahamas", code: "bs", continent: "North America" },
                { country: "Bangladesh", code: "bd", continent: "Asia" },
                { country: "Belgium", code: "be", continent: "Europe" },
                { country: "Brazil", code: "br", continent: "South America" },
                { country: "Canada", code: "ca", continent: "North America" },
                { country: "Chile", code: "cl", continent: "South America" },
                { country: "China", code: "cn", continent: "Asia" },
                { country: "Colombia", code: "co", continent: "South America" },
                { country: "Croatia", code: "hr", continent: "Europe" },
                { country: "Cuba", code: "cu", continent: "North America" },
                { country: "Czechia", code: "cz", continent: "Europe" },
                { country: "Denmark", code: "dk", continent: "Europe" },
                { country: "Egypt", code: "eg", continent: "Africa" },
                { country: "Finland", code: "fi", continent: "Europe" },
                { country: "France", code: "fr", continent: "Europe" },
                { country: "Germany", code: "de", continent: "Europe" },
                { country: "Greece", code: "gr", continent: "Europe" },
                { country: "Hungary", code: "hu", continent: "Europe" },
                { country: "Iceland", code: "is", continent: "Europe" },
                { country: "India", code: "in", continent: "Asia" },
                { country: "Indonesia", code: "id", continent: "Asia" },
                { country: "Iran", code: "ir", continent: "Asia" },
                { country: "Iraq", code: "iq", continent: "Asia" },
                { country: "Ireland", code: "ie", continent: "Europe" },
                { country: "Israel", code: "il", continent: "Asia" },
                { country: "Italy", code: "it", continent: "Europe" },
                { country: "Jamaica", code: "jm", continent: "North America" },
                { country: "Japan", code: "jp", continent: "Asia" },
                { country: "Kenya", code: "ke", continent: "Africa" },
                { country: "Mexico", code: "mx", continent: "North America" },
                { country: "Morocco", code: "ma", continent: "Africa" },
                { country: "Netherlands", code: "nl", continent: "Europe" },
                { country: "New Zealand", code: "nz", continent: "Oceania" },
                { country: "Nigeria", code: "ng", continent: "Africa" },
                { country: "North Korea", code: "kp", continent: "Asia" },
                { country: "Norway", code: "no", continent: "Europe" },
                { country: "Pakistan", code: "pk", continent: "Asia" },
                { country: "Peru", code: "pe", continent: "South America" },
                { country: "Philippines", code: "ph", continent: "Asia" },
                { country: "Poland", code: "pl", continent: "Europe" },
                { country: "Portugal", code: "pt", continent: "Europe" },
                { country: "Qatar", code: "qa", continent: "Asia" },
                { country: "Russia", code: "ru", continent: "Europe" },
                { country: "Saudi Arabia", code: "sa", continent: "Asia" },
                { country: "Singapore", code: "sg", continent: "Asia" },
                { country: "South Africa", code: "za", continent: "Africa" },
                { country: "South Korea", code: "kr", continent: "Asia" },
                { country: "Spain", code: "es", continent: "Europe" },
                { country: "Sweden", code: "se", continent: "Europe" },
                { country: "Switzerland", code: "ch", continent: "Europe" },
                { country: "Thailand", code: "th", continent: "Asia" },
                { country: "Turkey", code: "tr", continent: "Asia" },
                { country: "Ukraine", code: "ua", continent: "Europe" },
                { country: "United Kingdom", code: "gb", continent: "Europe" },
                { country: "United States", code: "us", continent: "North America" },
                { country: "Vietnam", code: "vn", continent: "Asia" }
            ];

            const missions = [
                {
                    title: "Operation: First Contact",
                    briefing: (name) => `Agent ${name}, verify basic intel. Identify 5 European flags. Secure the sector.`,
                    filter: (f) => f.continent === "Europe",
                    target: 5,
                    timeLimit: 60
                },
                {
                    title: "Operation: Eastern Sun",
                    briefing: (name) => `Focus on Asia. The encryption is harder. You have less time to react.`,
                    filter: (f) => f.continent === "Asia",
                    target: 5,
                    timeLimit: 45
                },
                {
                    title: "Operation: New World",
                    briefing: (name) => `Target the Americas. The system is unstable; speed is of the essence.`,
                    filter: (f) => ["North America", "South America"].includes(f.continent),
                    target: 5,
                    timeLimit: 30
                },
                {
                    title: "Operation: Global Crisis",
                    briefing: (name) => `FINAL TEST. Global identifiers scrambled. Identify 8 flags from anywhere.`,
                    filter: (f) => true,
                    target: 8,
                    timeLimit: 45
                }
            ];

            const screens = {
                credit: document.getElementById('screen-credit'),
                setup: document.getElementById('screen-setup'),
                briefing: document.getElementById('screen-briefing'),
                game: document.getElementById('screen-game'),
                outcome: document.getElementById('screen-outcome'),
                gameover: document.getElementById('screen-gameover')
            };

            function showScreen(screenKey) {
                Object.values(screens).forEach(s => s.classList.add('hidden'));
                screens[screenKey].classList.remove('hidden');
            }

            function loadCampaignMission() {
                if (gameState.level >= missions.length) {
                    endGame(true, "Campaign Successful. Global security restored.");
                    return;
                }
                const mission = missions[gameState.level];
                document.getElementById('briefing-title').textContent = mission.title;
                document.getElementById('briefing-text').textContent = mission.briefing(gameState.agentName);
                document.getElementById('briefing-region').textContent = "VARIOUS";
                document.getElementById('briefing-targets').textContent = mission.target;
                document.getElementById('briefing-time').textContent = mission.timeLimit + "s";
                document.getElementById('briefing-details').classList.remove('hidden');
                document.getElementById('btn-start-mission').onclick = () => startCampaignLevel(mission);
                showScreen('briefing');
            }

            function startCampaignLevel(mission) {
                gameState.currentMission = mission;
                gameState.missionProgress = 0;
                gameState.timeLeft = mission.timeLimit;
                gameState.maxTime = mission.timeLimit;
                setupGameUI();
                startTimer(() => handleCampaignTimeout());
                nextQuestion();
            }

            function handleCampaignTimeout() {
                clearInterval(gameState.timerInterval);
                showOutcome(false, "Time limit exceeded. The link was severed.");
            }

            function startTimeAttack() {
                gameState.timeLeft = 60;
                gameState.maxTime = 60;
                gameState.lives = "∞"; 
                document.getElementById('briefing-title').textContent = "TIME ATTACK MODE";
                document.getElementById('briefing-text').textContent = "Identify as many flags as possible. Speed scales difficulty.";
                document.getElementById('briefing-details').classList.add('hidden');
                document.getElementById('btn-start-mission').onclick = () => {
                    setupGameUI();
                    startTimer(() => endGame(false, "Connection Lost"));
                    nextQuestion();
                };
                showScreen('briefing');
            }

            function setupGameUI() {
                updateHUD();
                showScreen('game');
            }

            function startTimer(onComplete) {
                clearInterval(gameState.timerInterval);
                const timerDisplay = document.getElementById('game-timer');
                const timerBar = document.getElementById('timer-bar');
                gameState.timerInterval = setInterval(() => {
                    if (gameState.isPaused) return;
                    gameState.timeLeft--;
                    timerDisplay.textContent = gameState.timeLeft;
                    const pct = (gameState.timeLeft / gameState.maxTime) * 100;
                    timerBar.style.width = `${Math.min(pct, 100)}%`;
                    if (pct < 20) timerBar.classList.add('critical');
                    else timerBar.classList.remove('critical');
                    if (gameState.timeLeft <= 0) {
                        clearInterval(gameState.timerInterval);
                        onComplete();
                    }
                }, 1000);
            }

            function nextQuestion() {
                let pool = flags;
                if (gameState.mode === 'campaign') {
                    pool = flags.filter(gameState.currentMission.filter);
                }
                const target = pool[Math.floor(Math.random() * pool.length)];
                gameState.currentFlag = target;
                document.getElementById('flag-display').src = `${FLAG_CDN}${target.code}.png`;
                const options = new Set([target.country]);
                while (options.size < 4) {
                    const r = flags[Math.floor(Math.random() * flags.length)];
                    options.add(r.country);
                }
                renderOptions(Array.from(options).sort(() => Math.random() - 0.5));
            }

            function renderOptions(opts) {
                const container = document.getElementById('options-container');
                container.innerHTML = '';
                document.getElementById('feedback-msg').textContent = '';
                opts.forEach(country => {
                    const btn = document.createElement('button');
                    btn.className = 'option-btn';
                    btn.textContent = country;
                    btn.onclick = () => handleAnswer(btn, country);
                    container.appendChild(btn);
                });
            }

            function handleAnswer(btn, answer) {
                if (btn.disabled) return;
                const allBtns = document.querySelectorAll('.option-btn');
                allBtns.forEach(b => b.disabled = true);
                gameState.stats.total++;
                const isCorrect = answer === gameState.currentFlag.country;
                if (isCorrect) {
                    gameState.score += (gameState.mode === 'campaign' ? 10 : 50);
                    gameState.stats.correct++;
                    btn.classList.add('correct');
                    document.getElementById('feedback-msg').textContent = "IDENTITY CONFIRMED";
                    document.getElementById('feedback-msg').className = "text-success";
                    if (gameState.mode === 'campaign') {
                        gameState.missionProgress++;
                    } else {
                        const bonus = Math.max(2, 5 - Math.floor(gameState.score / 1000));
                        gameState.timeLeft += bonus;
                        if(gameState.timeLeft > gameState.maxTime) gameState.maxTime = gameState.timeLeft;
                    }
                } else {
                    btn.classList.add('wrong');
                    allBtns.forEach(b => {
                        if (b.textContent === gameState.currentFlag.country) b.classList.add('correct');
                    });
                    document.getElementById('feedback-msg').textContent = "ERROR: MISMATCH";
                    document.getElementById('feedback-msg').className = "text-danger";
                    document.querySelector('.game-container').classList.add('anim-shake');
                    setTimeout(() => document.querySelector('.game-container').classList.remove('anim-shake'), 400);
                    if (gameState.mode === 'campaign') {
                        gameState.lives--;
                    } else {
                        gameState.timeLeft -= 10;
                    }
                }
                updateHUD();
                setTimeout(() => {
                    if (checkEndConditions()) return;
                    nextQuestion();
                }, 1200);
            }

            function checkEndConditions() {
                if (gameState.mode === 'campaign' && gameState.lives <= 0) {
                    showOutcome(false, "Too many errors. Agent disavowed.");
                    return true;
                }
                if (gameState.mode === 'campaign' && gameState.missionProgress >= gameState.currentMission.target) {
                    clearInterval(gameState.timerInterval);
                    showOutcome(true, "Sector cleared. Preparing next assignment.");
                    return true;
                }
                if (gameState.mode === 'timeAttack' && gameState.timeLeft <= 0) {
                     clearInterval(gameState.timerInterval);
                     endGame(false, "Connection Timed Out");
                     return true;
                }
                return false;
            }

            function updateHUD() {
                document.getElementById('game-score').textContent = gameState.score;
                document.getElementById('game-lives').textContent = gameState.lives;
            }

            function showOutcome(success, msg) {
                if (success) {
                    document.getElementById('outcome-title').textContent = "MISSION SUCCESS";
                    document.getElementById('outcome-title').className = "text-success";
                    document.getElementById('outcome-text').textContent = msg;
                    document.getElementById('btn-outcome-action').textContent = "NEXT MISSION";
                    document.getElementById('btn-outcome-action').onclick = () => {
                        gameState.level++;
                        loadCampaignMission();
                    };
                } else {
                    document.getElementById('outcome-title').textContent = "MISSION FAILED";
                    document.getElementById('outcome-title').className = "text-danger";
                    document.getElementById('outcome-text').textContent = msg;
                    document.getElementById('btn-outcome-action').textContent = "RETRY MISSION";
                    document.getElementById('btn-outcome-action').onclick = () => loadCampaignMission();
                }
                showScreen('outcome');
            }

            function endGame(victory, msg) {
                clearInterval(gameState.timerInterval);
                const title = victory ? "CAMPAIGN COMPLETE" : "GAME OVER";
                const color = victory ? "text-success" : "text-danger";
                document.getElementById('gameover-title').textContent = title;
                document.getElementById('gameover-title').className = color;
                document.getElementById('gameover-msg').textContent = msg || (victory ? "You have proven yourself a master agent." : "System lockdown initiated.");
                document.getElementById('final-score').textContent = gameState.score;
                const acc = Math.round((gameState.stats.correct / gameState.stats.total) * 100) || 0;
                document.getElementById('final-accuracy').textContent = acc + "%";
                document.getElementById('final-status').textContent = victory ? "COMPLETED" : "TERMINATED";
                document.getElementById('final-status').className = victory ? "hud-value text-success" : "hud-value text-danger";
                showScreen('gameover');
            }

            document.getElementById('btn-intro-start').onclick = () => {
                showScreen('setup');
                document.getElementById('input-agent-name').focus();
            };

            document.getElementById('btn-submit-name').onclick = () => {
                const input = document.getElementById('input-agent-name');
                const name = input.value.trim() || "Agent";
                gameState.agentName = name;
                input.disabled = true;
                document.getElementById('btn-submit-name').classList.add('hidden');
                document.querySelector('#screen-setup p').textContent = `Welcome, ${name}. Select protocol:`;
                document.getElementById('mode-selection').classList.remove('hidden');
            };

            window.startGame = function(mode) {
                gameState.mode = mode;
                gameState.score = 0;
                gameState.lives = 3;
                gameState.level = 0;
                gameState.stats = { correct: 0, total: 0 };
                if (mode === 'campaign') loadCampaignMission();
                else startTimeAttack();
            };
        });
    </script>
</body>
</html>
